<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taselaskuri</title>

    <style>
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
            padding: 5px;
        }

        button:disabled,
        input[type="submit"]:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>

<body>

<h1>Taselaskuri</h1>

<form method="POST">
    <table id="balanceSheetTable">
        <thead>
            <tr>
                <th>Nimi</th>
                <th>Tyyppi</th>
                <th>Kirjanpitoarvo</th>
                <th>Markkina-arvo</th>
                <th>Kommentti</th>
                <th>Poista</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><input type="text" name="name[]" required></td>
                <td>
                    <select name="class[]" required>
                        <option value="">– valitse –</option>
                        <option value="Vara">Vara</option>
                        <option value="Velka">Velka</option>
                    </select>
                </td>
                <td><input type="number" step="0.01" name="book_value[]" required></td>
                <td><input type="number" step="0.01" name="market_value[]" required></td>
                <td><input type="text" name="comment[]"></td>
                <td>
                    <button type="button" class="remove-btn" onclick="removeRow(this)">
                        Poista
                    </button>
                </td>
            </tr>
        </tbody>
    </table>

    <br>
    <button type="button" onclick="addRow()">Lisää rivi</button>
    <input type="submit" id="submitBtn" value="Lähetä" disabled>
</form>

<script>
function addRow() {
    const tbody = document.querySelector("#balanceSheetTable tbody");
    const row = document.createElement("tr");

    row.innerHTML = `
        <td><input type="text" name="name[]" required></td>
        <td>
            <select name="class[]" required>
                <option value="">– valitse –</option>
                <option value="Vara">Vara</option>
                <option value="Velka">Velka</option>
            </select>
        </td>
        <td><input type="number" step="0.01" name="book_value[]" required></td>
        <td><input type="number" step="0.01" name="market_value[]" required></td>
        <td><input type="text" name="comment[]"></td>
        <td>
            <button type="button" class="remove-btn" onclick="removeRow(this)">
                Poista
            </button>
        </td>
    `;

    tbody.appendChild(row);
    attachValidation(row);
    updateRemoveButtons();
    validateForm();
}

function removeRow(button) {
    const tbody = document.querySelector("#balanceSheetTable tbody");
    if (tbody.rows.length > 1) {
        button.closest("tr").remove();
    }
    updateRemoveButtons();
    validateForm();
}

function updateRemoveButtons() {
    const rows = document.querySelectorAll("#balanceSheetTable tbody tr");
    document.querySelectorAll(".remove-btn").forEach(btn => {
        btn.disabled = rows.length === 1;
    });
}

function validateForm() {
    const requiredFields = document.querySelectorAll("#balanceSheetTable [required]");
    const isValid = [...requiredFields].every(field => field.value.trim() !== "");
    document.getElementById("submitBtn").disabled = !isValid;
}

function attachValidation(row) {
    row.querySelectorAll("input, select").forEach(el => {
        el.addEventListener("input", validateForm);
        el.addEventListener("change", validateForm);
    });
}

document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("#balanceSheetTable tbody tr").forEach(attachValidation);
    updateRemoveButtons();
    validateForm();
});
</script>
{% if result %}
<hr>

<h2>Tulos</h2>

<table>
    <tr>
        <th></th>
        <th>Kirjanpitoarvo</th>
        <th>Markkina-arvo</th>
    </tr>
    <tr>
        <td><strong>Vastaavaa (Assets)</strong></td>
        <td>{{ "%.2f"|format(result.total_assets_book) }}</td>
        <td>{{ "%.2f"|format(result.total_assets_market) }}</td>
    </tr>
    <tr>
        <td><strong>Vastattavaa (Liabilities)</strong></td>
        <td>{{ "%.2f"|format(result.total_liabilities_book) }}</td>
        <td>{{ "%.2f"|format(result.total_liabilities_market) }}</td>
    </tr>
    <tr>
        <td><strong>Oma pääoma (Equity)</strong></td>
        <td>{{ "%.2f"|format(result.equity_book) }}</td>
        <td>{{ "%.2f"|format(result.equity_market) }}</td>
    </tr>
</table>
{% endif %}
</body>
</html>

