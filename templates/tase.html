<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taselaskuri</title>

    <style>
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
            padding: 5px;
        }

        button:disabled,
        input[type="submit"]:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>

<body>

<h1>Taselaskuri</h1>

<form method="POST">
    <table id="balanceSheetTable">
        <thead>
            <tr>
                <th>Nimi</th>
                <th>Tyyppi</th>
                <th>Kirjanpitoarvo</th>
                <th>Markkina-arvo</th>
                <th>Kommentti</th>
                <th>Poista</th>
            </tr>
        </thead>
        <tbody>
        {% if rows %}
            {% for row in rows %}
            <tr>
                <td><input type="text" name="name[]" value="{{ row.name }}" required></td>
                <td>
                    <select name="class[]" required>
                        <option value="">– valitse –</option>
                        <option value="Vara" {{ "selected" if row.class == "Vara" }}>Vara</option>
                        <option value="Velka" {{ "selected" if row.class == "Velka" }}>Velka</option>
                    </select>
                </td>
                <td><input type="number" step="0.01" name="book_value[]" value="{{ row.book_value }}" required></td>
                <td><input type="number" step="0.01" name="market_value[]" value="{{ row.market_value }}" required></td>
                <td><input type="text" name="comment[]" value="{{ row.comment }}"></td>
                <td>
                    <button type="button" class="remove-btn" onclick="removeRow(this)">
                        Poista
                    </button>
                </td>
            </tr>
            {% endfor %}
        {% else %}
            <!-- First empty row (GET request) -->
            <tr>
                <td><input type="text" name="name[]" required></td>
                <td>
                    <select name="class[]" required>
                        <option value="">– valitse –</option>
                        <option value="Vara">Vara</option>
                        <option value="Velka">Velka</option>
                    </select>
                </td>
                <td><input type="number" step="0.01" name="book_value[]" required></td>
                <td><input type="number" step="0.01" name="market_value[]" required></td>
                <td><input type="text" name="comment[]"></td>
                <td>
                    <button type="button" class="remove-btn" onclick="removeRow(this)">
                        Poista
                    </button>
                </td>
            </tr>
        {% endif %}
        </tbody>
    </table>

    <br>
    <button type="button" onclick="addRow()">Lisää rivi</button>
    <input type="submit" id="submitBtn" value="Luo tase" disabled>
</form>

<script>
function addRow() {
    const tbody = document.querySelector("#balanceSheetTable tbody");
    const row = document.createElement("tr");

    row.innerHTML = `
        <td><input type="text" name="name[]" required></td>
        <td>
            <select name="class[]" required>
                <option value="">– valitse –</option>
                <option value="Vara">Vara</option>
                <option value="Velka">Velka</option>
            </select>
        </td>
        <td><input type="number" step="0.01" name="book_value[]" required></td>
        <td><input type="number" step="0.01" name="market_value[]" required></td>
        <td><input type="text" name="comment[]"></td>
        <td>
            <button type="button" class="remove-btn" onclick="removeRow(this)">
                Poista
            </button>
        </td>
    `;

    tbody.appendChild(row);
    attachValidation(row);
    updateRemoveButtons();
    validateForm();
}

function removeRow(button) {
    const tbody = document.querySelector("#balanceSheetTable tbody");
    if (tbody.rows.length > 1) {
        button.closest("tr").remove();
    }
    updateRemoveButtons();
    validateForm();
}

function updateRemoveButtons() {
    const rows = document.querySelectorAll("#balanceSheetTable tbody tr");
    document.querySelectorAll(".remove-btn").forEach(btn => {
        btn.disabled = rows.length === 1;
    });
}

function validateForm() {
    const requiredFields = document.querySelectorAll("#balanceSheetTable [required]");
    const isValid = [...requiredFields].every(field => field.value.trim() !== "");
    document.getElementById("submitBtn").disabled = !isValid;
}

function attachValidation(row) {
    row.querySelectorAll("input, select").forEach(el => {
        el.addEventListener("input", validateForm);
        el.addEventListener("change", validateForm);
    });
}

document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("#balanceSheetTable tbody tr").forEach(attachValidation);
    updateRemoveButtons();
    validateForm();
});
</script>
{% if result %}
<hr>

<h2>Tulos</h2>

<table>
    <tr>
        <th></th>
        <th>Kirjanpitoarvo</th>
        <th>Markkina-arvo</th>
    </tr>
    <tr>
        <td><strong>Vastaavaa (Assets)</strong></td>
        <td>{{ "%.2f"|format(result.total_assets_book) }}</td>
        <td>{{ "%.2f"|format(result.total_assets_market) }}</td>
    </tr>
    <tr>
        <td><strong>Vastattavaa (Liabilities)</strong></td>
        <td>{{ "%.2f"|format(result.total_liabilities_book) }}</td>
        <td>{{ "%.2f"|format(result.total_liabilities_market) }}</td>
    </tr>
    <tr>
        <td><strong>Oma pääoma (Equity)</strong></td>
        <td>{{ "%.2f"|format(result.equity_book) }}</td>
        <td>{{ "%.2f"|format(result.equity_market) }}</td>
    </tr>
</table>
<style>
  .balance-wrapper {
    display: flex;
    gap: 80px;
    flex-wrap: wrap;
  }

  .balance-block {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .chart {
    display: flex;
    gap: 40px;
    align-items: flex-end;
    position: relative;
    height: 320px;
  }

  .column {
    display: flex;
    flex-direction: column-reverse;
    width: 70px;
    height: 300px;
    border: 1px solid #bbb;
    position: relative;
  }

  .asset {
    background: #2E7D32;
  }

  .liability {
    background: #C62828;
  }

  .equity-positive {
    background: #1565C0;
  }

  .equity-negative {
    background: #8B0000;
  }

  .segment {
    width: 100%;
  }

  .neg-equity-column {
    width: 70px;
    height: 300px;
    position: relative;
    border: 1px dashed #8B0000;
  }

  .neg-equity-segment {
    position: absolute;
    top: 0;
    width: 100%;
    background: #8B0000;
  }

  .label {
    font-size: 12px;
    margin-top: 8px;
    text-align: center;
  }
</style>

<hr>
<h2>Visual Balance Breakdown</h2>

<div class="balance-wrapper">

{% for value_type in ["book", "market"] %}

  {% set assets_total = result['total_assets_' + value_type] %}
  {% if assets_total == 0 %}
    {% set assets_total = 1 %}
  {% endif %}

  {% set equity = result['equity_' + value_type] %}
  {% set negative_equity = equity < 0 %}

  {% if negative_equity %}
    {% set total_liab = result.liabilities | sum(attribute=value_type + '_value') %}
    {% set scale = 300 / [assets_total, total_liab] | max %}
  {% else %}
    {% set scale = 300 / assets_total %}
  {% endif %}

  <div class="balance-block">

    <h3>{{ "Kirjanpitoarvo" if value_type == "book" else "Markkina-arvo" }}</h3>

    <div class="chart">

      <!-- ASSETS -->
      <div>
        <div class="column">
          {% for asset in result.assets %}
            {% set h = asset[value_type + '_value'] * scale %}
            <div class="segment asset"
                 style="height: {{ h }}px"
                 title="{{ asset.name }}: {{ asset[value_type + '_value'] }}">
            </div>
          {% endfor %}
        </div>
        <div class="label">Assets</div>
      </div>

      <!-- LIABILITIES (+ equity if positive) -->
      <div>
        <div class="column">

          {% for liab in result.liabilities %}
            {% set h = liab[value_type + '_value'] * scale %}
            <div class="segment liability"
                 style="height: {{ h }}px"
                 title="{{ liab.name }}: {{ liab[value_type + '_value'] }}">
            </div>
          {% endfor %}

          {% if not negative_equity %}
            {% set h = equity * scale %}
            <div class="segment equity-positive"
                 style="height: {{ h }}px"
                 title="Equity: {{ equity }}">
            </div>
          {% endif %}

        </div>
        <div class="label">
          Liabilities{% if not negative_equity %} + Equity{% endif %}
        </div>
      </div>

      <!-- NEGATIVE EQUITY (only if equity < 0) -->
        {% if negative_equity %}
        {% set total_liab = result.liabilities | sum(attribute=value_type + '_value') %}
        {# equity_height = absolute difference between assets and liabilities #}
        {% set equity_height = (total_liab - assets_total) * scale %}

        {# top of negative equity = top of liabilities bar minus equity height #}
        {% set equity_top = liability_height %}  {# start at top of liability bar #}

        <div>
        <div class="neg-equity-column">
            <div class="neg-equity-segment"
                style="height: {{ equity_height }}px; top: {{ equity_top }}px;"
                title="Negative equity: {{ equity }}">
            </div>
        </div>
        <div class="label">
            Negative equity {{ equity }}
        </div>
        </div>
        {% endif %}

    </div>

  </div>

{% endfor %}

</div>
{% endif %}
</body>
</html>

