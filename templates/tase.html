<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Taselaskuri</title>

    <!-- Chart libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2"></script>

    <style>
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
            padding: 5px;
        }

        button:disabled,
        input[type="submit"]:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .charts {
            display: flex;
            gap: 40px;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        canvas {
            border: 1px solid #ccc;
        }
    </style>
</head>

<body>

<h1>Taselaskuri</h1>

<form method="POST">
    <table id="balanceSheetTable">
        <thead>
            <tr>
                <th>Nimi</th>
                <th>Tyyppi</th>
                <th>Kirjanpitoarvo</th>
                <th>Markkina-arvo</th>
                <th>Kommentti</th>
                <th>Poista</th>
            </tr>
        </thead>

        <tbody>
        {% if rows %}
            {% for row in rows %}
            <tr>
                <td><input type="text" name="name[]" value="{{ row.name }}" required></td>
                <td>
                    <select name="class[]" required>
                        <option value="">– valitse –</option>
                        <option value="Vara" {% if row.class == "Vara" %}selected{% endif %}>Vara</option>
                        <option value="Velka" {% if row.class == "Velka" %}selected{% endif %}>Velka</option>
                    </select>
                </td>
                <td><input type="number" step="0.01" name="book_value[]" value="{{ row.book_value }}" required></td>
                <td><input type="number" step="0.01" name="market_value[]" value="{{ row.market_value }}" required></td>
                <td><input type="text" name="comment[]" value="{{ row.comment }}"></td>
                <td>
                    <button type="button" class="remove-btn" onclick="removeRow(this)">Poista</button>
                </td>
            </tr>
            {% endfor %}
        {% else %}
            <tr>
                <td><input type="text" name="name[]" required></td>
                <td>
                    <select name="class[]" required>
                        <option value="">– valitse –</option>
                        <option value="Vara">Vara</option>
                        <option value="Velka">Velka</option>
                    </select>
                </td>
                <td><input type="number" step="0.01" name="book_value[]" required></td>
                <td><input type="number" step="0.01" name="market_value[]" required></td>
                <td><input type="text" name="comment[]"></td>
                <td>
                    <button type="button" class="remove-btn" onclick="removeRow(this)">Poista</button>
                </td>
            </tr>
        {% endif %}
        </tbody>
    </table>

    <br>
    <button type="button" onclick="addRow()">Lisää rivi</button>
    <input type="submit" id="submitBtn" value="Laske" disabled>
</form>

<!-- ================= FORM LOGIC ================= -->
<script>
function addRow() {
    const tbody = document.querySelector("#balanceSheetTable tbody");

    const row = document.createElement("tr");
    row.innerHTML = `
        <td><input type="text" name="name[]" required></td>
        <td>
            <select name="class[]" required>
                <option value="">– valitse –</option>
                <option value="Vara">Vara</option>
                <option value="Velka">Velka</option>
            </select>
        </td>
        <td><input type="number" step="0.01" name="book_value[]" required></td>
        <td><input type="number" step="0.01" name="market_value[]" required></td>
        <td><input type="text" name="comment[]"></td>
        <td><button type="button" class="remove-btn" onclick="removeRow(this)">Poista</button></td>
    `;

    tbody.appendChild(row);
    attachValidation(row);
    updateRemoveButtons();
    validateForm();
}

function removeRow(btn) {
    const tbody = document.querySelector("#balanceSheetTable tbody");
    if (tbody.rows.length > 1) {
        btn.closest("tr").remove();
    }
    updateRemoveButtons();
    validateForm();
}

function updateRemoveButtons() {
    document.querySelectorAll(".remove-btn")
        .forEach(b => b.disabled = document.querySelectorAll("#balanceSheetTable tbody tr").length === 1);
}

function validateForm() {
    const required = document.querySelectorAll("#balanceSheetTable [required]");
    const valid = [...required].every(f => f.value.trim() !== "");
    document.getElementById("submitBtn").disabled = !valid;
}

function attachValidation(row) {
    row.querySelectorAll("input, select").forEach(el => {
        el.addEventListener("input", validateForm);
        el.addEventListener("change", validateForm);
    });
}

document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("#balanceSheetTable tbody tr").forEach(attachValidation);
    updateRemoveButtons();
    validateForm();
});
</script>

<!-- ================= TREEMAPS ================= -->

{% if result %}
<div class="charts">
    <div>
        <h3>Kirjanpitoarvo</h3>
        <canvas id="treemapBook" width="400" height="300"></canvas>
    </div>
    <div>
        <h3>Markkina-arvo</h3>
        <canvas id="treemapMarket" width="400" height="300"></canvas>
    </div>
</div>

<script>
// Prepare data for treemaps
const bookData = [
    {% for asset in result.assets %}
    { group: "Assets", label: "{{ asset.name }}", value: {{ asset.book_value }} }{% if not loop.last %},{% endif %}
    {% endfor %}
    {% if result.assets and result.liabilities %},{% endif %}
    {% for liability in result.liabilities %}
    { group: "Liabilities", label: "{{ liability.name }}", value: {{ liability.book_value }} }{% if not loop.last %},{% endif %}
    {% endfor %}
];

const marketData = [
    {% for asset in result.assets %}
    { group: "Assets", label: "{{ asset.name }}", value: {{ asset.market_value }} }{% if not loop.last %},{% endif %}
    {% endfor %}
    {% if result.assets and result.liabilities %},{% endif %}
    {% for liability in result.liabilities %}
    { group: "Liabilities", label: "{{ liability.name }}", value: {{ liability.market_value }} }{% if not loop.last %},{% endif %}
    {% endfor %}
];

console.log("Book Data:", bookData);
console.log("Market Data:", marketData);

function renderTreemap(id, data) {
    if (data.length === 0) {
        console.error(`No data for treemap: ${id}`);
        return;
    }
    
    new Chart(document.getElementById(id), {
        type: "treemap",
        data: {
            datasets: [{
                tree: data,
                key: "value",
                groups: ["group"],
                spacing: 1,
                backgroundColor(ctx) {
                    return ctx.raw.group === "Assets" ? "#0d6efd"
                         : ctx.raw.group === "Liabilities" ? "#dc3545"
                         : "#198754";
                },
                labels: { display: true, formatter: ctx => `${ctx.raw.label}: ${ctx.raw.value}` }
            }]
        },
        options: { plugins: { legend: { display: false } } }
    });
}

renderTreemap("treemapBook", bookData);
renderTreemap("treemapMarket", marketData);
</script>
{% endif %}

</body>
</html>
