<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taselaskuri</title>

    <style>
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
            padding: 5px;
        }

        button:disabled,
        input[type="submit"]:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>

<body>

<h1>Taselaskuri</h1>

<form method="POST">
    <table id="balanceSheetTable">
        <thead>
            <tr>
                <th>Nimi</th>
                <th>Tyyppi</th>
                <th>Kirjanpitoarvo</th>
                <th>Markkina-arvo</th>
                <th>Kommentti</th>
                <th>Poista</th>
            </tr>
        </thead>
        <tbody>
        {% if rows %}
            {% for row in rows %}
            <tr>
                <td><input type="text" name="name[]" value="{{ row.name }}" required></td>
                <td>
                    <select name="class[]" required>
                        <option value="">– valitse –</option>
                        <option value="Vara" {{ "selected" if row.class == "Vara" }}>Vara</option>
                        <option value="Velka" {{ "selected" if row.class == "Velka" }}>Velka</option>
                    </select>
                </td>
                <td><input type="number" step="0.01" name="book_value[]" value="{{ row.book_value }}" required></td>
                <td><input type="number" step="0.01" name="market_value[]" value="{{ row.market_value }}" required></td>
                <td><input type="text" name="comment[]" value="{{ row.comment }}"></td>
                <td>
                    <button type="button" class="remove-btn" onclick="removeRow(this)">
                        Poista
                    </button>
                </td>
            </tr>
            {% endfor %}
        {% else %}
            <!-- First empty row (GET request) -->
            <tr>
                <td><input type="text" name="name[]" required></td>
                <td>
                    <select name="class[]" required>
                        <option value="">– valitse –</option>
                        <option value="Vara">Vara</option>
                        <option value="Velka">Velka</option>
                    </select>
                </td>
                <td><input type="number" step="0.01" name="book_value[]" required></td>
                <td><input type="number" step="0.01" name="market_value[]" required></td>
                <td><input type="text" name="comment[]"></td>
                <td>
                    <button type="button" class="remove-btn" onclick="removeRow(this)">
                        Poista
                    </button>
                </td>
            </tr>
        {% endif %}
        </tbody>
    </table>

    <br>
    <button type="button" onclick="addRow()">Lisää rivi</button>
    <input type="submit" id="submitBtn" value="Luo tase" disabled>
</form>

<script>
function addRow() {
    const tbody = document.querySelector("#balanceSheetTable tbody");
    const row = document.createElement("tr");

    row.innerHTML = `
        <td><input type="text" name="name[]" required></td>
        <td>
            <select name="class[]" required>
                <option value="">– valitse –</option>
                <option value="Vara">Vara</option>
                <option value="Velka">Velka</option>
            </select>
        </td>
        <td><input type="number" step="0.01" name="book_value[]" required></td>
        <td><input type="number" step="0.01" name="market_value[]" required></td>
        <td><input type="text" name="comment[]"></td>
        <td>
            <button type="button" class="remove-btn" onclick="removeRow(this)">
                Poista
            </button>
        </td>
    `;

    tbody.appendChild(row);
    attachValidation(row);
    updateRemoveButtons();
    validateForm();
}

function removeRow(button) {
    const tbody = document.querySelector("#balanceSheetTable tbody");
    if (tbody.rows.length > 1) {
        button.closest("tr").remove();
    }
    updateRemoveButtons();
    validateForm();
}

function updateRemoveButtons() {
    const rows = document.querySelectorAll("#balanceSheetTable tbody tr");
    document.querySelectorAll(".remove-btn").forEach(btn => {
        btn.disabled = rows.length === 1;
    });
}

function validateForm() {
    const requiredFields = document.querySelectorAll("#balanceSheetTable [required]");
    const isValid = [...requiredFields].every(field => field.value.trim() !== "");
    document.getElementById("submitBtn").disabled = !isValid;
}

function attachValidation(row) {
    row.querySelectorAll("input, select").forEach(el => {
        el.addEventListener("input", validateForm);
        el.addEventListener("change", validateForm);
    });
}

document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("#balanceSheetTable tbody tr").forEach(attachValidation);
    updateRemoveButtons();
    validateForm();
});
</script>
{% if result %}
<hr>

<h2>Tulos</h2>

<table>
    <tr>
        <th></th>
        <th>Kirjanpitoarvo</th>
        <th>Markkina-arvo</th>
    </tr>
    <tr>
        <td><strong>Vastaavaa (Assets)</strong></td>
        <td>{{ "%.2f"|format(result.total_assets_book) }}</td>
        <td>{{ "%.2f"|format(result.total_assets_market) }}</td>
    </tr>
    <tr>
        <td><strong>Vastattavaa (Liabilities)</strong></td>
        <td>{{ "%.2f"|format(result.total_liabilities_book) }}</td>
        <td>{{ "%.2f"|format(result.total_liabilities_market) }}</td>
    </tr>
    <tr>
        <td><strong>Oma pääoma (Equity)</strong></td>
        <td>{{ "%.2f"|format(result.equity_book) }}</td>
        <td>{{ "%.2f"|format(result.equity_market) }}</td>
    </tr>
</table>
<hr>
<h2>Visual Balance Breakdown</h2>

<div style="display: flex; gap: 50px; flex-wrap: wrap;">

  {% for value_type in ["book", "market"] %}
  {% set total_height = result['total_assets_' + value_type] + result['equity_' + value_type] %}
  {% if total_height == 0 %}
    {% set total_height = 1 %} {# avoid division by zero #}
  {% endif %}
  <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
    <h3>{{ "Kirjanpitoarvo" if value_type == "book" else "Markkina-arvo" }}</h3>

    <div style="display: flex; align-items: flex-end; gap: 20px; height: 300px;">

      <!-- Asset Names -->
      <div style="display: flex; flex-direction: column; justify-content: flex-end; text-align: right; margin-right: 5px;">
        {% for asset in result.assets %}
          {% set height_px = (asset[value_type + '_value'] / total_height * 300) %}
          <div style="height: {{ height_px }}px; margin-bottom: 2px;">{{ asset.name }}</div>
        {% endfor %}
      </div>

      <!-- Asset Bar -->
      <div style="width: 60px; display: flex; flex-direction: column-reverse; border: 1px solid #ccc;">
        {% for asset in result.assets %}
          {% set height_px = (asset[value_type + '_value'] / total_height * 300) %}
          <div style="height: {{ height_px }}px; background-color: #4CAF50;" title="{{ asset.name }}: {{ asset[value_type + '_value'] }}"></div>
        {% endfor %}
      </div>

      <!-- Liability + Equity Bar -->
      <div style="width: 60px; display: flex; flex-direction: column-reverse; border: 1px solid #ccc;">
        {% for liab in result.liabilities %}
          {% set height_px = (liab[value_type + '_value'] / total_height * 300) %}
          <div style="height: {{ height_px }}px; background-color: #f44336;" title="{{ liab.name }}: {{ liab[value_type + '_value'] }}"></div>
        {% endfor %}
        {% set equity_height_px = (result['equity_' + value_type] / total_height * 300) %}
        <div style="height: {{ equity_height_px }}px; background-color: #FF9800;" title="Oma pääoma: {{ result['equity_' + value_type] }}"></div>
      </div>

      <!-- Liability + Equity Names -->
      <div style="display: flex; flex-direction: column; justify-content: flex-end; text-align: left; margin-left: 5px;">
        {% for liab in result.liabilities %}
          {% set height_px = (liab[value_type + '_value'] / total_height * 300) %}
          <div style="height: {{ height_px }}px; margin-bottom: 2px;">{{ liab.name }}</div>
        {% endfor %}
        <div style="height: {{ equity_height_px }}px; margin-bottom: 2px;">Oma pääoma</div>
      </div>

    </div>
  </div>
  {% endfor %}

</div>

{% endif %}
</body>
</html>

